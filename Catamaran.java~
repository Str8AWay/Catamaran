
// basic rules: 
// end level when all dogs are dead
// +10 points per treasure picked up
// -10 points per treasure picked up by dogs

import java.awt.*;
import java.awt.event.*;
import java.applet.*;
import java.net.*; 
import java.util.*;
import java.awt.Image.*; 

public class Catamaran extends Applet implements Runnable
{
	public static final String CATAMARAN_URL = "http://www.mscs.mu.edu/~fharunan/Games/Catamaran/";	

	public final int GAMESTART = 1;
	public final int GAMEPLAY = 2;
	public final int GAMEWON = 3; 
	public final int GAMELOST = 4; 
	int gameState; 
	
	int level = 1;
	CapnFerdinandLongwhiskers ferdie;
	ArrayList<RoyalNavySeadog> doggies;
	ArrayList<Booty> booties;
	ArrayList<SquirrelBullet> bullets;
	Image bulletImg;
	Thread anim;
	Image buffer;
	Graphics bufgr;
	Image bkgnd;
	int cut;
	Font font;
	int FRAME_DELAY = 50;
	public static final int VWIDTH = 640;
	public static final int VHEIGHT = 640;
	public static final int SCROLL = 160;  // Set edge limit for scrolling
	int vleft = 0;	// Pixel coord of left edge of viewable area; used for scrolling
	static final int MINY = 150; // prevent sprites from travelling on land or in air
	static final int MAXX = 2000; // prevent sprites from travelling forever off into never never land
	int points; 
	boolean spaceReleased; 
	int crewmembers; 

	public void init()
	{
		if (getKeyListeners().length < 1)
		{
			addMouseListener(new mseL());
			addKeyListener(new keyL());
		}

		gameState = GAMESTART;

		points = 0; 
		spaceReleased = false; 
		crewmembers = 5;

		buffer = createImage(VWIDTH,VHEIGHT);
		bufgr = buffer.getGraphics();
		font = new Font("Arial",Font.ITALIC,30);

		Image capt = null;
		try {
			capt = getImage(new URL(CATAMARAN_URL + "catBlock.png"));
		} catch (MalformedURLException e) {}

		ferdie = new CapnFerdinandLongwhiskers(this, capt, 50, 249);

		Image dog = null;
		try {
			dog = getImage(new URL(CATAMARAN_URL + "dogBlock.png"));
		} catch (MalformedURLException e) {}

		doggies = new ArrayList<RoyalNavySeadog>();
		Random rm = new Random();
		for (int i = 0; i < level*5; i++)
		{
			doggies.add(new RoyalNavySeadog(this, dog, rm.nextInt(MAXX - 64), rm.nextInt(VHEIGHT-MINY-64)+MINY));
		}

		Image chest = null;
		try {
			chest = getImage(new URL(CATAMARAN_URL + "treasureBlock.png"));
		} catch (MalformedURLException e) {}

		booties = new ArrayList<Booty>();
		for (int i = 0; i < level*10; i++)
		{
			booties.add(new Booty(this, chest, rm.nextInt(MAXX - 64), rm.nextInt(VHEIGHT-MINY-64)+MINY));
		}
		try {
			bulletImg = getImage(new URL(CATAMARAN_URL + "squirrelBlock.png"));
		} catch (MalformedURLException e) {}

		bullets = new ArrayList<SquirrelBullet>();
		try {
			bkgnd = getImage(new URL(CATAMARAN_URL + "beach.png"));
		} catch (MalformedURLException e) {}
	}

	public void start()
	{
		anim = new Thread(this);
		anim.start();
	}	
	public void stop()
	{
		anim = null;
	}

	public void run()
	{

		while (true)
		{

			switch (gameState)
			{
				case GAMEPLAY: 
					if (spaceReleased)
					{
						if (crewmembers > 0)
						{
							int bulX;
							if (ferdie.dir == CapnFerdinandLongwhiskers.RIGHT) bulX = ferdie.locx+ferdie.width-20;
							else bulX = ferdie.locx-ferdie.width+20;
							bullets.add(new SquirrelBullet(this, bulletImg, bulX, ferdie.locy, ferdie.dir));
							crewmembers--;
						}
						spaceReleased = false; 
					}
					ferdie.update();
					for (RoyalNavySeadog dog : doggies)
					{
						dog.update();
					}
					for (SquirrelBullet bullet : bullets)
					{
						bullet.update();
					}
					checkScrolling();
					checkCollisions();
					repaint();
					break;
				case GAMESTART:
				case GAMEWON:
				case GAMELOST:
					repaint();
					break;
			}
			try
			{
				Thread.sleep(FRAME_DELAY);
			}
			catch (InterruptedException e) {}
		}		
	}
	void checkScrolling()
	{
		// Test if ferdie is at edge of view window and scroll appropriately
		if (ferdie.locx < (vleft+SCROLL))
		{
			vleft = ferdie.locx-SCROLL;
			if (vleft < 0)
				vleft = 0;
		}
		if ((ferdie.locx + ferdie.width) > (vleft+VWIDTH-SCROLL))
		{
			vleft = ferdie.locx+ferdie.width-VWIDTH+SCROLL;
			if (vleft > MAXX - VWIDTH)
				vleft = MAXX - VWIDTH;
		}
	}

	void checkCollisions()
	{
		Rectangle catBox = ferdie.collisionBox();
		
		// Cat and Treasure collisions
		Iterator<Booty> treasureIter = booties.iterator();
		while (treasureIter.hasNext())
		{
			Booty booty = treasureIter.next();
			if (catBox.intersects(booty.collisionBox()))
			{
				points += 10;
				treasureIter.remove();
				break;
			}
		}
		
		Iterator<SquirrelBullet> bulletIter;
		Iterator<RoyalNavySeadog> doggiesIter = doggies.iterator();
		while(doggiesIter.hasNext())
		{
			RoyalNavySeadog dog = doggiesIter.next();

			// Cat and Dog collisions
			Rectangle dogBox = dog.collisionBox();
			if (catBox.intersects(dogBox)) 
			{  
				gameState = GAMELOST;
				//ferdie.capt = ferdie.flipImageHor(ferdie.capt);
				ferdie.capt = ferdie.flipImageVert(ferdie.capt);
				break;
			}

			// Dog and Treasure collisions
			treasureIter = booties.iterator();
			while (treasureIter.hasNext())
			{
				Booty booty = treasureIter.next();
				if (dogBox.intersects(booty.collisionBox()) && booty.onscreen()) // Only lets dogs get treasure if it is onscreen
				{
					points -= 10;
					treasureIter.remove();
					break;
				}
			}
		}

		// Dog and Bullet collisions
		bulletIter = bullets.iterator();
		while (bulletIter.hasNext())
		{
			SquirrelBullet bullet = bulletIter.next();
			doggiesIter = doggies.iterator();

			// if a bullet goes offscreen, delete it so that it doesn't attack things we can't see
			if (!bullet.onscreen())
			{
				bulletIter.remove();
				crewmembers++;
				continue;
			}

			while (doggiesIter.hasNext())
			{
				RoyalNavySeadog dog = doggiesIter.next();
				if (bullet.collisionBox().intersects(dog.collisionBox()))
				{
					points += 5;
					doggiesIter.remove();
					bulletIter.remove();
					crewmembers++;
					break; 
				}
			}
		}

		// Dog and Dog collisions
		for (int i = 0; i < doggies.size(); i++)
		{
			Rectangle dogBox = doggies.get(i).collisionBox();
			for (int j = 0; j < doggies.size(); j++)
			{
				if ((i != j) && dogBox.intersects(doggies.get(j).collisionBox()))
				{
					if (doggies.get(j).dir ==  RoyalNavySeadog.UP) doggies.get(j).dir = RoyalNavySeadog.DOWN; 
					else if (doggies.get(j).dir ==  RoyalNavySeadog.DOWN) doggies.get(j).dir =  RoyalNavySeadog.UP;
					else if (doggies.get(j).dir ==  RoyalNavySeadog.LEFT) doggies.get(j).dir =  RoyalNavySeadog.RIGHT;
					else if (doggies.get(j).dir ==  RoyalNavySeadog.RIGHT) doggies.get(j).dir =  RoyalNavySeadog.LEFT; 
					if (doggies.get(i).dir ==  RoyalNavySeadog.UP) doggies.get(i).dir =  RoyalNavySeadog.DOWN; 
					else if (doggies.get(i).dir ==  RoyalNavySeadog.DOWN) doggies.get(i).dir =  RoyalNavySeadog.UP;
					else if (doggies.get(i).dir ==  RoyalNavySeadog.LEFT) doggies.get(i).dir =  RoyalNavySeadog.RIGHT;
					else if (doggies.get(i).dir ==  RoyalNavySeadog.RIGHT) doggies.get(i).dir =  RoyalNavySeadog.LEFT; 
				}
			}
		}
		// If all dogs have been killed, then we won the level
		if (doggies.isEmpty())
		{
			gameState = GAMEWON; 
		}
	}

	public void update(Graphics g)
	{
		paint(bufgr);
		g.drawImage(buffer,0,0,this);
	}

	public void paint(Graphics g)
	{

		switch (gameState)
		{
			case GAMESTART:
				g.setColor(Color.yellow);
				g.fillRect(0,0,VWIDTH,VHEIGHT);
				g.setColor(Color.blue);
				g.setFont(font);
				g.drawString("Click to Start", VWIDTH/2 - 100, VHEIGHT/2);
				break;

			case GAMEPLAY:
				g.setColor(Color.white);
				g.fillRect(0,0,VWIDTH,VHEIGHT);
				g.setClip(0,0,VWIDTH,VHEIGHT);
				cut = vleft;
				g.drawImage(bkgnd, -cut, 0, this);
				g.drawImage(bkgnd, 1280-cut, 0, this);
				g.drawImage(bkgnd, 2560-cut, 0, this);
				g.drawImage(bkgnd, 3840-cut, 0, this);
				g.drawImage(bkgnd, 5120-cut, 0, this);

				ferdie.paint(g);

				for (RoyalNavySeadog dog : doggies)
				{
					dog.paint(g);
				}

				for (Booty booty : booties)
				{
					booty.paint(g);
				}

				for (SquirrelBullet bullet : bullets)
				{
					bullet.paint(g);
				}

				g.setColor(Color.black);
				g.setFont(font);	
				g.drawString("Points: " + points, 100, 140);
				break;

			case GAMEWON:
				g.drawString("You win!",100,100);
				break;

			case GAMELOST:
				g.drawString("You lose.",100,100);
				break;
		}		
	}

	private class mseL extends MouseAdapter
	{
		public void mouseClicked(MouseEvent e)
		{
			requestFocus();
			if (gameState == GAMESTART) 
				gameState = GAMEPLAY; 
		}
	}

	private class keyL extends KeyAdapter
	{
		public void keyPressed(KeyEvent e)
		{
			int key = e.getKeyCode();
			switch (key)
			{
				case KeyEvent.VK_A: 
				case KeyEvent.VK_LEFT:
					ferdie.setDir(CapnFerdinandLongwhiskers.LEFT);
					ferdie.dx = -4;
					break;
				case KeyEvent.VK_RIGHT:
				case KeyEvent.VK_D: 
					ferdie.setDir(CapnFerdinandLongwhiskers.RIGHT);
					ferdie.dx = 4;
					break;
				case KeyEvent.VK_UP:
				case KeyEvent.VK_W:
					ferdie.dy = -4;
					break;
				case KeyEvent.VK_DOWN:
				case KeyEvent.VK_S:  
					ferdie.dy = 4;
					break;
				case KeyEvent.VK_R:
					init();
					break;
			}
		}
		public void keyReleased(KeyEvent e)
		{
			int key = e.getKeyCode();
			switch (key)
			{
				case KeyEvent.VK_A: 
				case KeyEvent.VK_LEFT:
				case KeyEvent.VK_RIGHT:
				case KeyEvent.VK_D:
					ferdie.dx = 0;
				case KeyEvent.VK_UP:
				case KeyEvent.VK_W:
				case KeyEvent.VK_DOWN:
				case KeyEvent.VK_S:
					ferdie.dy = 0;
					break;
				case KeyEvent.VK_SPACE:
					spaceReleased = true; 
					break;
			}
		}
	}
}
